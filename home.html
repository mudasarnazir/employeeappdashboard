<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet"/>
  <style>
    :root {
      --sidebar-width: 270px;
      --sidebar-collapsed-width: 70px;
      --sidebar-bg: #192132;
      --sidebar-active: #2563eb;
      --sidebar-txt: #fff;
      --sidebar-txt-muted: #d3dbe7;
      --sidebar-border: #1d253a;
      --logout-bg: #141a28;
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      background: #f8fafc;
    }
    .main-layout {
      display: flex;
      height: 100vh;
      min-height: 0;
    }
    .sidebar {
      background: var(--sidebar-bg);
      color: var(--sidebar-txt);
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      transition: width 0.2s, min-width 0.2s;
      box-shadow: 2px 0 12px rgba(25,33,50,0.08);
      z-index: 10;
      position: relative;
    }
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
      min-width: var(--sidebar-collapsed-width);
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 2rem 1.4rem 1.3rem 1.5rem;
      height: 78px;
    }
    .sidebar-title {
      font-size: 1.7rem;
      font-weight: 700;
      color: #4f8cff;
      letter-spacing: 0.5px;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .sidebar.collapsed .sidebar-title {
      opacity: 0;
      pointer-events: none;
      width: 0;
      margin: 0;
      padding: 0;
    }
    .sidebar-toggle {
      background: none;
      border: none;
      color: #4f8cff;
      font-size: 2rem;
      cursor: pointer;
      outline: none;
      padding: 0.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.14s;
      box-shadow: none;
    }
    .sidebar-toggle:hover {
      background: #233153;
      color: #fff;
    }
    .sidebar-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar-nav li {
      margin: 0.5rem 0;
    }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      color: var(--sidebar-txt);
      text-decoration: none;
      padding: 0.85rem 1.4rem;
      font-size: 1.09rem;
      border-radius: 0.7rem;
      transition: background 0.14s, color 0.15s;
      gap: 1.1rem;
    }
    .sidebar-nav a:hover {
      background: #233153;
      color: var(--sidebar-active);
    }
    .sidebar.collapsed .sidebar-text {
      display: none;
    }
    .sidebar-logout {
      margin-top: auto;
      padding: 1.1rem 1.1rem;
      border-top: 1px solid var(--sidebar-border);
      background: var(--logout-bg);
    }
    .sidebar-logout a {
      display: flex;
      align-items: center;
      color: #fff;
      text-decoration: none;
      font-size: 1.09rem;
      gap: 1.1rem;
      padding: 0.85rem 0.7rem;
      border-radius: 0.6rem;
      transition: background 0.15s;
    }
    .sidebar-logout a:hover {
      background: #233153;
      color: #ff5656;
    }
    .sidebar.collapsed .sidebar-logout .sidebar-text {
      display: none;
    }
    .main-content {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

    .topbar {
      height: 62px;
      background: #fff;
      box-shadow: 0 1px 0 0 #e3e8ee;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .topbar-title {
      font-size: 1.18rem;
      color: #1e293b;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    #topbar-profile-photo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: contain;
      flex-shrink: 0;
      display: block;
    }
    .content-area {
  flex: 1;
  overflow-y: auto;
  padding: 2rem 2.2rem;
  background: #f8fafc;
}
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.7rem;
      margin-bottom: 2.2rem;
    }
    .dashboard-card {
      background: #fff;
      border-radius: 1.3rem;
      box-shadow: 0 1px 8px rgba(30,41,59,0.07);
      padding: 1.5rem 1.5rem 1.2rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.1rem;
      transition: box-shadow 0.18s, transform 0.18s;
      cursor: pointer;
      border-left: 5px solid #2563eb1a;
    }
    .dashboard-cards .dashboard-card:nth-child(1):hover {
  background: #e0f2fe;       /* light blue */
  border-left: 5px solid #3b82f6;  /* blue-500 */
}
.dashboard-cards .dashboard-card:nth-child(2):hover {
  background: #dcfce7;       /* light green */
  border-left: 5px solid #10b981;  /* green-500 */
}
.dashboard-cards .dashboard-card:nth-child(3):hover {
  background: #fef9c3;       /* light yellow */
  border-left: 5px solid #f59e0b;  /* amber-500 */
}
.dashboard-cards .dashboard-card:nth-child(4):hover {
  background: #fee2e2;       /* light red */
  border-left: 5px solid #ef4444;  /* red-500 */
}

    .card-icon {
      width: 54px;
      height: 54px;
      background: #eff6ff;
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.1rem;
      color: #2563eb;
      margin-right: 0.5rem;
    }
    .card-info {
      flex: 1;
    }
    .card-title {
      color: #475569;
      font-size: 1.12rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }
    .card-value {
      font-size: 2.05rem;
      font-weight: 700;
      color: #1e293b;
      letter-spacing: 0.1px;
    }
    .dashboard-section {
      margin-bottom: 2.3rem;
    }
    .section-title {
      font-size: 1.12rem;
      color: #1e293b;
      font-weight: 700;
      margin-bottom: 1.2rem;
      letter-spacing: 0.2px;
    }
    .announcements-list {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 1px 8px rgba(30,41,59,0.07);
      padding: 1.1rem 1.4rem;
      list-style: none;
      margin: 0;
    }
    .announcements-list li {
      padding: 0.7rem 0;
      color: #475569;
      border-bottom: 1px solid #e6e7eb;
    }
    .announcements-list li:last-child {
      border-bottom: none;
    }
    .checkins-list {
      display: flex;
      gap: 0.8rem;
      padding: 0.5rem 0;
    }
    .checkin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #2563eb;
      background: #e3e8ee;
      font-weight: 600;
      font-size: 1.1rem;
      color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.14s;
    }
    .checkin-avatar:hover {
      box-shadow: 0 2px 10px rgba(37,99,235,0.11);
      border-color: #1d4ed8;
    }
    .checkin-idno {
      font-size: 0.8rem;
      font-weight: 700;
    }
    .quick-actions {
      display: flex;
      gap: 1.3rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .quick-action-btn {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 0.7rem;
      padding: 0.85rem 1.55rem;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(37,99,235,0.07);
      transition: background 0.13s, box-shadow 0.13s, transform 0.12s;
    }
    .quick-action-btn i {
      font-size: 1.25rem;
    }
    .quick-action-btn:hover {
      background: #1d4ed8;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 2px 16px rgba(37,99,235,0.13);
    }
    @media (max-width: 600px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      .quick-actions {
        flex-direction: column;
        gap: 0.6rem;
      }
    }
    .employee-toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .search-container {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 0.8rem;
      box-shadow: 0 1px 8px rgba(30,41,59,0.07);
      padding: 0 1rem;
      flex-grow: 1;
    }
    .search-container i {
      color: #94a3b8;
      font-size: 1.2rem;
    }
    #searchInput {
      border: none;
      outline: none;
      padding: 0.85rem 0.7rem;
      font-size: 1rem;
      width: 100%;
      background: transparent;
    }
    .filter-container select {
      padding: 0.85rem 1rem;
      font-size: 1rem;
      border-radius: 0.8rem;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      color: #334155;
      cursor: pointer;
      outline: none;
    }
    .add-employee-btn {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 0.7rem;
      padding: 0.85rem 1.55rem;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      cursor: pointer;
      transition: background 0.13s;
    }
    .add-employee-btn:hover {
      background: #1d4ed8;
    }
    .employee-table-container {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 1px 8px rgba(30,41,59,0.07);
      overflow-x: auto;
    }
    .employee-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }
    .employee-table th,
    .employee-table td {
      padding: 1.1rem 1.5rem;
      border-bottom: 1px solid #eaf0f6;
    }
    .employee-table th {
      font-size: 0.9rem;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    .employee-table td {
      color: #334155;
      font-size: 1rem;
    }
    .employee-table tbody tr {
      cursor: pointer;
      transition: background-color 0.15s;
    }
    .employee-table tbody tr:hover {
      background-color: #f8fafc;
    }
    .status-active,
    .status-on-duty {
      color: #16a34a;
      background: #dcfce7;
      padding: 0.2rem 0.6rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .status-inactive {
      color: #dc2626;
      background: #fee2e2;
      padding: 0.2rem 0.6rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .loader-container {
      text-align: center;
      padding: 3rem;
      display: none;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem 0;
    }
    .pagination-btn {
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      margin: 0 0.3rem;
    }
    .pagination-btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    .pagination-btn.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(30,41,59,0.6);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
      overflow-y: auto;
      padding: 2rem 0;
    }
    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 1.2rem;
      box-shadow: 0 10px 40px rgba(30,41,59,0.2);
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 1.5rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.2rem;
    }
    .modal-content .form-group {
      margin-bottom: 0;
    }
    .modal-content label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #475569;
    }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      font-size: 1rem;
      margin-top: 0.4rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e2e8f0;
    }
    .modal-btn {
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 0.6rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .modal-btn.save {
      background: #2563eb;
      color: #fff;
    }
    .modal-btn.save:hover {
      background: #1d4ed8;
      box-shadow: 0 2px 10px rgba(37,99,235,0.2);
    }
    .modal-btn.cancel {
      background: #f1f5f9;
      color: #475569;
    }
    .modal-btn.cancel:hover {
      background: #e2e8f0;
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <aside id="sidebar" class="sidebar expanded">
      <div class="sidebar-header">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          <i id="sidebarToggleIcon" class="ri-arrow-left-s-line"></i>
        </button>
        <span class="sidebar-title">Admin Panel</span>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="#" id="nav-dashboard"><i class="ri-dashboard-2-line"></i><span class="sidebar-text">Dashboard</span></a></li>
          <li><a href="#" id="nav-employees"><i class="ri-group-line"></i><span class="sidebar-text">Employees</span></a></li>
          <li><a href="#" id="nav-attendance"><i class="ri-calendar-check-line"></i><span class="sidebar-text">Attendance</span></a></li>
        </ul>
      </nav>
      <div class="sidebar-logout">
        <a href="#" id="logoutBtn"><i class="ri-logout-box-line"></i><span class="sidebar-text">Logout</span></a>
      </div>
    </aside>
    <div class="main-content">
      <header class="topbar" id="topbar">
        <div class="topbar-title">Welcome, <span id="topbar-username">Admin</span></div>
        <div class="user-profile"><img id="topbar-profile-photo" src="default-user.png" alt="Profile Picture"/></div>
      </header>
      <div class="content-area" id="dashboard-section">
        <div class="dashboard-cards">
          <div class="dashboard-card"><div class="card-icon"><i class="ri-group-line"></i></div><div class="card-info"><div class="card-title">Total Employees</div><div class="card-value" id="total-employees-value"></div></div></div>
          <div class="dashboard-card"><div class="card-icon"><i class="ri-user-follow-line"></i></div><div class="card-info"><div class="card-title">Present Today</div><div class="card-value" id="present-today-value"></div></div></div>
          <div class="dashboard-card"><div class="card-icon"><i class="ri-hotel-bed-line"></i></div><div class="card-info"><div class="card-title">On Leave</div><div class="card-value" id="on-leave-value"></div></div></div>
          <div class="dashboard-card"><div class="card-icon"><i class="ri-task-line"></i></div><div class="card-info"><div class="card-title">Pending Tasks</div><div class="card-value" id="pending-tasks-value"></div></div></div>
        </div>
        <div class="dashboard-section"><div class="section-title">Announcements</div><ul class="announcements-list" id="announcements-list"><li>Loading announcements…</li></ul></div>
        <div class="dashboard-section"><div class="section-title">Recent Check-ins</div><div class="checkins-list" id="checkins-list"></div></div>
        <div class="dashboard-section"><div class="section-title">Quick Actions</div><div class="quick-actions"><button class="quick-action-btn" id="quickAddEmployeeBtn"><i class="ri-user-add-line"></i>Add Employee</button><button class="quick-action-btn"><i class="ri-verified-badge-line"></i>Approve Leave</button><button class="quick-action-btn"><i class="ri-calendar-todo-line"></i>Add Announcement</button><button class="quick-action-btn"><i class="ri-task-line"></i>Assign Task</button></div></div>
      </div>
      <div class="content-area" id="employees-section" style="display:none;">
        <div class="employee-toolbar">
          <div class="search-container">
            <i class="ri-search-line"></i>
            <input type="text" id="searchInput" placeholder="Search and press Enter...">
          </div>
          <div class="filter-container">
            <select id="filterBy">
              <option value="IDNo">ID No</option>
              <option value="Name">Name</option>
              <option value="Location">Location</option>
              <option value="Contract">Contract</option>
            </select>
          </div>
          <button id="columnPickerBtn" class="pagination-btn">Columns</button>
          <button class="add-employee-btn"><i class="ri-user-add-line"></i> Add Employee</button>
        </div>
        <div class="employee-table-container">
          <table class="employee-table">
            <thead><tr></tr></thead>
            <table class="employee-table">
  <thead>
    <tr>
      <th>ID No</th>
      <th>Name</th>
      <th>Contact</th>
      <th>Location</th>
      <th>Status</th>
      <!-- add any others you need -->
    </tr>
  </thead>
  <tbody id="employee-table-body"></tbody>
</table>

          </table>

        </div>
        <div id="loader" class="loader-container">
          <div class="loader"></div>
          <p>Loading Employees...</p>
        </div>
        <div class="pagination-container">
          <button id="firstPageBtn" class="pagination-btn">First</button>
          <button id="prevPageBtn" class="pagination-btn">Previous</button>
          <span id="paginationNumbers"></span>
          <button id="nextPageBtn" class="pagination-btn">Next</button>
          <button id="lastPageBtn" class="pagination-btn">Last</button>
          &nbsp;&nbsp;Go to page:
          <input id="gotoPageInput" type="number" min="1" style="width: 60px;">
          <button id="gotoPageBtn" class="pagination-btn">Go</button>
        </div>
      </div>
      <div class="content-area" id="attendance-section" style="display:none;">
        <div class="attendance-toolbar" style="margin-bottom:1.5rem; display:flex; align-items:center; gap:1rem;">
    <label for="attendanceDate" style="font-weight:600;">Select Date:</label>
    <input type="date"
           id="attendanceDate"
           style="padding:0.5rem; border-radius:0.5rem; border:1px solid #e2e8f0;"
    />
  </div>
        <div class="dashboard-cards">
          <div class="dashboard-card" id="card-total-employees">
            <div class="card-icon"><i class="ri-group-line"></i></div>
            <div class="card-info">
              <div class="card-title">Total Employees</div>
              <div class="card-value" id="total-employees-attendance-value">0</div>
            </div>
          </div>
          <div class="dashboard-card" id="card-total-checkin">
            <div class="card-icon"><i class="ri-calendar-check-line"></i></div>
            <div class="card-info">
              <div class="card-title">Total Check-in</div>
              <div class="card-value" id="total-checkins-value">0</div>
            </div>
          </div>
          <div class="dashboard-card" id="card-not-checked-in">
            <div class="card-icon"><i class="ri-user-unfollow-line"></i></div>
            <div class="card-info">
              <div class="card-title">Not Checked In</div>
              <div class="card-value" id="not-checked-in-value">0</div>
            </div>
          </div>
        </div>

        <div class="dashboard-section">
          <div class="section-title">Attendance Records</div>

          <div style="margin:1rem 0;display:flex;justify-content:flex-end">
  <input id="attendanceSearch"
         placeholder="Search ID, name or location…"
         style="padding:.55rem 1rem;border:1px solid #e2e8f0;border-radius:.6rem;width:250px;">
</div>

          <div class="employee-table-container">
            <table class="employee-table">
              <thead>
                <tr>
                  <th>ID No</th>
                  <th>Name</th>
                  <th>Check-In</th>
                  <th>Check-Out</th>
                  <th>Contract</th>
                  <th>Location</th>
                  <th>Geo-Point</th>
                </tr>
              </thead>
              <tbody id="attendance-table-body">
                <tr>
                  <td>10303</td>
                  <td>—</td>
                  <td>12:39:56 PM</td>
                  <td>12:54:27 PM</td>
                  <td>Dubai Office</td>
                  <td>Al Barsh 1</td>
                  <td>25.1362619°, 55.2553337°</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      </div>
  </div>
  <div id="employeeModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h2 class="modal-title">Employee Details</h2>
      <form id="employeeForm">
        <input type="hidden" id="employeeDocId">
        <div class="form-grid">
          <div class="form-group"><label for="modal-idno">ID No</label><input id="modal-idno" type="text"></div>
          <div class="form-group"><label for="modal-name">Name</label><input id="modal-name" type="text"></div>
          <div class="form-group"><label for="modal-contact">Contact</label><input id="modal-contact" type="text"></div>
          <div class="form-group"><label for="modal-email">Email</label><input id="modal-email" type="email"></div>
          <div class="form-group"><label for="modal-dob">Date of Birth</label><input id="modal-dob" type="text"></div>
          <div class="form-group"><label for="modal-nationality">Nationality</label><input id="modal-nationality" type="text"></div>
          <div class="form-group"><label for="modal-designation">Designation</label><input id="modal-designation" type="text"></div>
          <div class="form-group"><label for="modal-location">Location</label><input id="modal-location" type="text"></div>
          <div class="form-group"><label for="modal-shift">Shift</label><input id="modal-shift" type="text"></div>
          <div class="form-group"><label for="modal-hours">Hours</label><input id="modal-hours" type="number"></div>
          <div class="form-group"><label for="modal-acc">Accommodation</label><input id="modal-acc" type="text"></div>
          <div class="form-group"><label for="modal-trans">Transport</label><input id="modal-trans" type="text"></div>
          <div class="form-group"><label for="modal-contract">Contract</label><input id="modal-contract" type="text"></div>
          <div class="form-group"><label for="modal-status">Status</label><select id="modal-status"><option value="Active">Active</option><option value="On Duty">On Duty</option><option value="Inactive">Inactive</option></select></div>
          <div class="form-group"><label for="modal-pp">Passport No</label><input id="modal-pp" type="text"></div>
          <div class="form-group"><label for="modal-eid">Emirates ID</label><input id="modal-eid" type="text"></div>
          <div class="form-group"><label for="modal-visa">VISA No</label><input id="modal-visa" type="text"></div>
          <div class="form-group"><label for="modal-labour-expiry">Labour Card Expiry</label><input id="modal-labour-expiry" type="text"></div>
          <div class="form-group"><label for="modal-sira-no">SIRA No</label><input id="modal-sira-no" type="number"></div>
          <div class="form-group"><label for="modal-sira-exp">SIRA Expiry</label><input id="modal-sira-exp" type="text"></div>
          <div class="form-group"><label for="modal-sapid">SAP ID</label><input id="modal-sapid" type="number"></div>
          <div class="form-group"><label for="modal-zone">Zone</label><input id="modal-zone" type="text"></div>
          <div class="form-group"><label for="modal-coordinates">Coordinates</label><input id="modal-coordinates" type="text"></div>
          <div class="form-group"><label for="modal-sn">SN</label><input id="modal-sn" type="number"></div>
          <div class="form-group"><label for="modal-expiry">Expiry (Timestamp)</label><input id="modal-expiry" type="number"></div>
          <div class="form-group"><label for="modal-expiry-dot1">Expiry.1</label><input id="modal-expiry-dot1" type="number"></div>
          <div class="form-group"><label for="modal-expiry-dot2">Expiry.2</label><input id="modal-expiry-dot2" type="text"></div>
          <div class="form-group"><label for="modal-deviceid">Device ID</label><input id="modal-deviceid" type="text"></div>
          <div class="form-group"><label for="modal-brand">Device Brand</label><input id="modal-brand" type="text"></div>
          <div class="form-group"><label for="modal-model">Device Model</label><input id="modal-model" type="text"></div>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="modal-btn cancel">Cancel</button>
          <button type="submit" id="saveBtn" class="modal-btn save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  <div id="columnPickerModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h2 class="modal-title" style="font-size: 1.2rem;">Select Columns</h2>
      <form id="columnPickerForm"></form>
      <div class="modal-actions">
        <button type="button" id="columnPickerCancelBtn" class="modal-btn cancel">Cancel</button>
        <button type="button" id="columnPickerSaveBtn" class="modal-btn save">Save</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBa8U_eXrjO4iG1a5RpFDQjLErg05RiYr4",
      authDomain: "universal-employee-app.firebaseapp.com",
      projectId: "universal-employee-app",
      storageBucket: "universal-employee-app.firebasestorage.app",
      messagingSenderId: "97480581971",
      appId: "1:97480581971:web:0bfaca675293ef42fcb7a6",
      measurementId: "G-EMFPT5WX5C"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const totalEmployeesValue = document.getElementById("total-employees-value");
    const presentTodayValue = document.getElementById("present-today-value");
    const onLeaveValue = document.getElementById("on-leave-value");
    const pendingTasksValue = document.getElementById("pending-tasks-value");
    const checkinsList = document.getElementById("checkins-list");
    const topbarUsername = document.getElementById("topbar-username");
    const topbarProfilePhoto = document.getElementById("topbar-profile-photo");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const sidebar = document.getElementById("sidebar");
    const sidebarIcon = document.getElementById("sidebarToggleIcon");

    const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', async e => {
    e.preventDefault();            // stay on the same page while signing out
    try {
      await signOut(auth);         // Firebase logout
      location.href = 'index.html';// send back to login / landing page
    } catch (err) {
      console.error('Logout failed', err);
      alert('Could not log out. Please try again.');
    }
  });
}
    const getNameFromEmail = email => {
      if (!email) return 'Admin';
      return email.split('@')[0].replace(/[^a-zA-Z]/g,'').replace(/^\w/, c => c.toUpperCase());
    };
    function displayRecentCheckins(checkins = []) {
      if (!checkinsList) return;
      if (!checkins.length) {
        checkinsList.innerHTML = "<p>No check-ins yet today.</p>";
        return;
      }
      checkinsList.innerHTML = checkins.map(u => {
        const img = u.photoURL
          ? `<img src="${u.photoURL}" alt="${u.name}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
          : `<span class="checkin-idno">${u.idNo || 'N/A'}</span>`;
        return `<div class="checkin-avatar" title="${u.name}">${img}</div>`;
      }).join('');
    }
    function listenToDashboardSummary(company = "Spark Security Services") {
      const path = `dashboardSummaries/daily_${company.replace(/\s+/g,'_')}`;
      onSnapshot(doc(db, path), snap => {
        if (!snap.exists()) return;
        const d = snap.data();
        totalEmployeesValue.textContent = d.totalEmployees || 0;
        presentTodayValue.textContent = d.presentToday || 0;
        onLeaveValue.textContent = d.onLeave || 0;
        pendingTasksValue.textContent = d.pendingTasks || 0;
        displayRecentCheckins(d.recentCheckins || []);
      });
    }
    async function fetchAdminProfileByEmail(email, company = "Spark Security Services") {
      if (!topbarProfilePhoto) return;
      try {
        const col = collection(db, `companies/${company}/employees`);
        const q = query(col, where("Email", "==", email));
        const s = await getDocs(q);
        if (s.empty) return;
        const data = s.docs[0].data();
        let url = data.photoURL || data.profileImageUrl || data.avatar || data.photoUrl || null;
        if (!url && data.IDNo) {
          const path = `${company}/employeeProfilePhotos/${data.IDNo}.jpg`;
          url = await getDownloadURL(storageRef(storage, path));
        }
        if (url) {
          topbarProfilePhoto.src = url;
          topbarProfilePhoto.removeAttribute('srcset');
        }
      } catch {}
    }
    function initSidebar() {
      if (!sidebarToggle || !sidebar || !sidebarIcon) return;
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        sidebarIcon.classList.toggle('ri-arrow-right-s-line');
        sidebarIcon.classList.toggle('ri-arrow-left-s-line');
      });
    }
    function initTopbar() {
      if (!topbarUsername) return;
      onAuthStateChanged(auth, async user => {
        if (!user) { location.href = 'index.html'; return; }
        topbarUsername.textContent = user.displayName || getNameFromEmail(user.email);
        await fetchAdminProfileByEmail(user.email);
        listenToDashboardSummary();
      });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      initSidebar();
      initTopbar();
    });
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, query, where,
      orderBy, limit, getDocs, startAfter,
      addDoc, doc, updateDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, getDownloadURL }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBa8U_eXrjO4iG1a5RpFDQjLErg05RiYr4",
      authDomain: "universal-employee-app.firebaseapp.com",
      projectId: "universal-employee-app",
      storageBucket: "universal-employee-app.firebasestorage.app",
      messagingSenderId: "97480581971",
      appId: "1:97480581971:web:0bfaca675293ef42fcb7a6",
      measurementId: "G-EMFPT5WX5C"
    };
    const app     = initializeApp(firebaseConfig);
    const auth    = getAuth(app);
    const db      = getFirestore(app);
    const storage = getStorage(app);
    const SEARCH_FUNCTION_URL   = "https://us-central1-universal-employee-app.cloudfunctions.net/searchEmployees";
    const COMPANY_NAME          = "Spark Security Services";
    const FIREBASE_COLLECTION   = `companies/${COMPANY_NAME}/employees`;
    const allColumns = [
      { key:"IDNo", label:"ID No" },{key:"Name",label:"Name"},
      { key:"Contact",label:"Contact" },{key:"Location",label:"Location"},
      { key:"Status",label:"Status" },{key:"Designation",label:"Designation"},
      { key:"Contract",label:"Contract" },{key:"Shift",label:"Shift"},
      { key:"Acc",label:"Accommodation" },{key:"Trans",label:"Transport"},
      { key:"PP",label:"Passport No" },{key:"EID",label:"Emirates ID"},
      { key:"VISA",label:"VISA No" },{key:"SiraNo",label:"SIRA No"},
      { key:"SAPID",label:"SAP ID" },{key:"SN",label:"SN"}
    ];
    let visibleColumns = allColumns.slice(0,5).map(c=>c.key);
    if (localStorage.getItem("employeeTableCols")) {
      visibleColumns = JSON.parse(localStorage.getItem("employeeTableCols"));
    }
    const fieldMap = {
      IDNo:'modal-idno',Name:'modal-name',Contact:'modal-contact',
      Email:'modal-email',DOB:'modal-dob',Nationality:'modal-nationality',
      Designation:'modal-designation',Location:'modal-location',
      Shift:'modal-shift',Hours:'modal-hours',Acc:'modal-acc',
      Trans:'modal-trans',Contract:'modal-contract',Status:'modal-status',
      PP:'modal-pp',EID:'modal-eid',VISA:'modal-visa',
      LabourCardExpiry:'modal-labour-expiry',
      SiraNo:'modal-sira-no',SiraEXP:'modal-sira-exp',
      SAPID:'modal-sapid',Zone:'modal-zone',Coordinates:'modal-coordinates',
      SN:'modal-sn',Expiry:'modal-expiry','Expiry.1':'modal-expiry-dot1',
      'Expiry.2':'modal-expiry-dot2',deviceid:'modal-deviceid',
      brand:'modal-brand',model:'modal-model'
    };
    const tableBody         = document.getElementById('employee-table-body');
    const loader            = document.getElementById('loader');
    const firstPageBtn      = document.getElementById('firstPageBtn');
    const prevPageBtn       = document.getElementById('prevPageBtn');
    const nextPageBtn       = document.getElementById('nextPageBtn');
    const lastPageBtn       = document.getElementById('lastPageBtn');
    const paginationNumbers = document.getElementById('paginationNumbers');
    const gotoPageInput     = document.getElementById('gotoPageInput');
    const gotoPageBtn       = document.getElementById('gotoPageBtn');
    const columnPickerBtn   = document.getElementById('columnPickerBtn');
    const columnPickerModal = document.getElementById('columnPickerModal');
    const columnPickerForm  = document.getElementById('columnPickerForm');
    const columnPickerCancel= document.getElementById('columnPickerCancelBtn');
    const columnPickerSave  = document.getElementById('columnPickerSaveBtn');
    const modal             = document.getElementById('employeeModal');
    const cancelBtn         = document.getElementById('cancelBtn');
    const employeeForm      = document.getElementById('employeeForm');
    const employeeDocId     = document.getElementById('employeeDocId');
    const modalTitle        = document.querySelector('#employeeModal .modal-title');
    const modalIdNoInput    = document.getElementById('modal-idno');
    const searchInput       = document.getElementById('searchInput');
    const filterBy          = document.getElementById('filterBy');
    const paginationContainer = document.querySelector('.pagination-container');
    const addBtn            = document.querySelector('.add-employee-btn');
    const EMPLOYEES_PER_PAGE = 15;
    let currentPage = 1, cursors = [], currentSearchTerm = "", searchTimeout;
    const currentEmployees = new Map(), currentSort = { column:"IDNo", direction:"asc" };
    function showLoader(on){ loader.style.display = on?'block':'none'; }
    function renderSortIcons(){
      document.querySelectorAll('th.sortable').forEach(th=>{
        const col = th.dataset.col;
        let icon = (!currentSearchTerm && currentSort.column===col)
          ? (currentSort.direction==='asc'?' ↑':' ↓') : '';
        th.innerHTML = allColumns.find(c=>c.key===col).label + icon;
      });
    }
    function renderPagination(isLast){
      firstPageBtn.disabled = prevPageBtn.disabled = currentPage===1;
      nextPageBtn.disabled = lastPageBtn.disabled = isLast;
    }
    function gotoPage(n){
      if (n<1||n===currentPage||(n>currentPage&&nextPageBtn.disabled)) return;
      currentPage=n; fetchPage();
    }
    firstPageBtn.onclick = ()=>gotoPage(1);
    prevPageBtn.onclick  = ()=>gotoPage(currentPage-1);
    nextPageBtn.onclick  = ()=>gotoPage(currentPage+1);
    lastPageBtn.onclick  = ()=>alert("Last page disabled");
    gotoPageBtn.onclick  = ()=>gotoPage(parseInt(gotoPageInput.value,10)||currentPage);
    function attachRowListeners(){
      document.querySelectorAll('.employee-table tbody tr[data-id]').forEach(tr=>{
        tr.onclick = ()=>openModal(currentEmployees.get(tr.dataset.id));
      });
    }
    function openModal(data){
      if (!data) return;
      modalTitle.textContent = 'Edit Employee';
      employeeForm.reset();
      employeeDocId.value = data.id;
      Object.entries(fieldMap).forEach(([key,id])=>{
        const inp = document.getElementById(id);
        if (inp) inp.value = data[key] ?? '';
      });
      modalIdNoInput.readOnly = true;
      modal.style.display='flex';
    }
    function renderRow(d){
      let row = `<tr data-id="${d.id}">`;
      visibleColumns.forEach(key=>{
        let v = d[key] ?? 'N/A';
        if (key==='Status') {
          const cls = (v==='Active'||v==='On Duty')?'status-active':'status-inactive';
          v = `<span class="${cls}">${v}</span>`;
        }
        row += `<td>${v}</td>`;
      });
      row += `</tr>`;
      tableBody.innerHTML += row;
    }
    function performCloudSearch(){
      showLoader(true);
      paginationContainer.style.display='none';
      tableBody.innerHTML='';
      const params = new URLSearchParams({company:COMPANY_NAME,field:filterBy.value,term:currentSearchTerm});
      fetch(`${SEARCH_FUNCTION_URL}?${params}`)
        .then(res=>res.json())
        .then(results=>{
          currentEmployees.clear();
          if (!results.length) {
            tableBody.innerHTML=`<tr><td colspan="${visibleColumns.length}">No results</td></tr>`;
          } else results.forEach(d=>{
            currentEmployees.set(d.id,d);
            renderRow(d);
          });
          attachRowListeners();
        })
        .catch(e=>{
          console.error("Search error",e);
          tableBody.innerHTML=`<tr><td colspan="${visibleColumns.length}">Error</td></tr>`;
        })
        .finally(()=>showLoader(false));
    }
    async function fetchFromFirestore(){
      showLoader(true);
      paginationContainer.style.display='flex';
      tableBody.innerHTML='';
      const ref = collection(db,FIREBASE_COLLECTION);
      const cons = [ orderBy(currentSort.column,currentSort.direction), limit(EMPLOYEES_PER_PAGE) ];
      if (currentPage>1 && cursors[currentPage-2]) cons.splice(1,0,startAfter(cursors[currentPage-2]));
      try {
        const snap = await getDocs(query(ref,...cons));
        currentEmployees.clear();
        if (snap.empty && currentPage===1) {
          tableBody.innerHTML=`<tr><td colspan="${visibleColumns.length}">No data</td></tr>`;
        } else {
          snap.forEach(docSnap=>{
            const d = { id: docSnap.id, ...docSnap.data() };
            currentEmployees.set(d.id,d);
            renderRow(d);
          });
          cursors[currentPage-1] = snap.docs[snap.docs.length-1];
        }
        renderPagination(snap.docs.length < EMPLOYEES_PER_PAGE);
        renderSortIcons();
        attachRowListeners();
      } catch(e){
        console.error("Fetch error",e);
        tableBody.innerHTML=`<tr><td colspan="${visibleColumns.length}">Error loading</td></tr>`;
      } finally { showLoader(false); }
    }
    function fetchPage(){
      currentSearchTerm?performCloudSearch():fetchFromFirestore();
    }
    searchInput.addEventListener('input',()=>{
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(()=>{
        currentSearchTerm = searchInput.value.trim();
        currentPage=1; cursors=[];
        fetchPage();
      },500);
    });
    filterBy.addEventListener('change',()=>{ if (currentSearchTerm) fetchPage(); });
    addBtn.onclick = ()=>{
      employeeForm.reset();
      employeeDocId.value = '';
      modalTitle.textContent = 'Add New Employee';
      modalIdNoInput.readOnly = false;
      modal.style.display='flex';
    };
	
    employeeForm.onsubmit = async e=>{
      e.preventDefault(); showLoader(true);
      const data = {};
      Object.entries(fieldMap).forEach(([key,id])=>{
        const inp = document.getElementById(id);
        if (inp) data[key] = inp.type==='number'? (inp.value?Number(inp.value):null) : inp.value;
      });
      try {
        if (employeeDocId.value) {
          await updateDoc(doc(db,FIREBASE_COLLECTION,employeeDocId.value),data);
        } else {
          if (!data.IDNo) { alert("ID No required"); return; }
          await setDoc(doc(db,FIREBASE_COLLECTION,data.IDNo.toString()),data);
        }
        modal.style.display='none';
        fetchPage();
      } catch(err){ console.error("Save error",err); alert("Save failed"); }
      finally{ showLoader(false); }
    };
    columnPickerBtn.onclick = ()=>{
      columnPickerForm.innerHTML = allColumns.map(c=>`
        <div class="form-group">
          <label>${c.label}</label>
          <input type="checkbox" value="${c.key}" ${visibleColumns.includes(c.key)?'checked':''}/>
        </div>
      `).join('');
      columnPickerModal.style.display='flex';
    };
    columnPickerCancel.onclick = ()=>columnPickerModal.style.display='none';
    columnPickerSave.onclick = ()=>{
      const picked = Array.from(columnPickerForm.querySelectorAll('input:checked')).map(i=>i.value);
      if (!picked.length){ alert("Select at least one"); return; }
      visibleColumns = picked;
      localStorage.setItem("employeeTableCols", JSON.stringify(picked));
      columnPickerModal.style.display='none';
      renderSortIcons();
      fetchPage();
    };
    cancelBtn.onclick = ()=>modal.style.display='none';
    modal.onclick = e=>{ if (e.target===modal) modal.style.display='none'; };
    document.addEventListener('DOMContentLoaded', ()=>{
      renderSortIcons();
      fetchPage();
    });
document.getElementById('quickAddEmployeeBtn').addEventListener('click', () => {
    showSection('employees-section');
    document.querySelector('.add-employee-btn').click();
  });
  </script>
  <script>
    function showSection(id) {
      document.getElementById('dashboard-section').style.display = id === 'dashboard-section' ? 'block' : 'none';
      document.getElementById('employees-section').style.display = id === 'employees-section' ? 'block' : 'none';
      document.getElementById('attendance-section').style.display = id === 'attendance-section' ? 'block' : 'none';
    }
    document.getElementById('nav-dashboard').addEventListener('click', () => showSection('dashboard-section'));
    document.getElementById('nav-employees').addEventListener('click', () => showSection('employees-section'));
    document.getElementById('nav-attendance').addEventListener('click', () => {
      showSection('attendance-section');
    });
    document.addEventListener('DOMContentLoaded', () => showSection('dashboard-section'));
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyBa8U_eXrjO4iG1a5RpFDQjLErg05RiYr4",
      authDomain: "universal-employee-app.firebaseapp.com",
      projectId: "universal-employee-app",
      storageBucket: "universal-employee-app.firebasestorage.app",
      messagingSenderId: "97480581971",
      appId: "1:97480581971:web:0bfaca675293ef42fcb7a6",
      measurementId: "G-EMFPT5WX5C"
    };

    const app = initializeApp(firebaseConfig, "attendanceApp");
    const db = getFirestore(app);
    const COMPANY_NAME = "Spark Security Services";

    let allEmployees = [];
    let attendanceRecords = [];

    async function fetchAllEmployees() {
      const employeesCol = collection(db, `companies/${COMPANY_NAME}/employees`);
      const employeeSnapshot = await getDocs(employeesCol);
      allEmployees = employeeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function fetchAttendanceRecords(dateStr) {
  attendanceRecords = [];

  for (const emp of allEmployees) {
    const docRef = doc(db, `companies/${COMPANY_NAME}/employees/${emp.id}/attendanceRecords/${dateStr}`);
    const snap = await getDoc(docRef);
    
    if (snap.exists()) {
      const data = snap.data();
      attendanceRecords.push({
        id: emp.id,
        Name: emp.Name || '',
        IDNo: emp.IDNo || '',
        Contract: data.contract || '',
        Location: data.locationName || '',
        checkInTime: data.checkInTimestamp || null,
        checkOutTime: data.checkOutTimestamp || null,
        geopoint: data.checkInLocation || null,
        status: data.status || 'PRESENT',
      });
    }
  }
}


    

    async function initializeAttendance() {
      const selectedDate = document.getElementById('attendanceDate').value;

      await fetchAllEmployees();
      await fetchAttendanceRecords(selectedDate); // e.g., "2025-08-02"


      document.getElementById('total-employees-attendance-value').textContent = allEmployees.length;
      document.getElementById('total-checkins-value').textContent = attendanceRecords.length;
      document.getElementById('not-checked-in-value').textContent = allEmployees.length - attendanceRecords.length;

      renderAttendanceTable(attendanceRecords); // Initially show checked-in employees
    }

    document.getElementById('card-total-employees').addEventListener('click', () => {
        const displayData = allEmployees.map(emp => {
        const attendance = attendanceRecords.find(att => att.IDNo === emp.IDNo);
        return { ...emp, ...attendance };
      });
      renderAttendanceTable(displayData);
    });

    document.getElementById('card-total-checkin').addEventListener('click', () => {
      const checkedInIds = new Set(attendanceRecords.map(rec => rec.IDNo));
      const checkedInData = allEmployees
        .filter(emp => checkedInIds.has(emp.IDNo))
        .map(emp => {
          const attendance = attendanceRecords.find(att => att.IDNo === emp.IDNo);
          return { ...emp, ...attendance };
        });
      renderAttendanceTable(checkedInData);
    });

    document.getElementById('card-not-checked-in').addEventListener('click', () => {
      const checkedInIds = new Set(attendanceRecords.map(rec => rec.IDNo));
      const notCheckedInData = allEmployees.filter(emp => !checkedInIds.has(emp.IDNo));
      renderAttendanceTable(notCheckedInData);
    });
    
    document.getElementById('nav-attendance').addEventListener('click', initializeAttendance);

  </script>
  <!-- keep only ONE attendance script and make it a module --><!-- ATTENDANCE MODULE – improved & cached -->
<!-- ATTENDANCE MODULE v2 – cards filter + live search -->
<!-- ATTENDANCE MODULE – drop-in replacement -->
<script type="module">
  import {
    getFirestore,
    collection,
    doc,
    getDocs,
    getDoc,
    getDocFromCache
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* ─────────── CONFIG ─────────── */
  const db       = getFirestore();                 // first Firebase app on the page
  const COMPANY  = "Spark Security Services";
  const SUMMARY  = `dashboardSummaries/daily_${COMPANY.replace(/\s+/g, "_")}`;

  /* ─────────── DOM refs ─────────── */
  const dateInput = document.getElementById("attendanceDate");
  dateInput.value = new Date().toISOString().slice(0, 10);

  const empVal   = document.getElementById("total-employees-attendance-value");
  const chkVal   = document.getElementById("total-checkins-value");
  const nChkVal  = document.getElementById("not-checked-in-value");

  const tableBody = document.getElementById("attendance-table-body");
  const searchBox = document.getElementById("attendanceSearch");     // <— add in HTML

  const cardAll  = document.getElementById("card-total-employees");
  const cardIn   = document.getElementById("card-total-checkin");
  const cardOut  = document.getElementById("card-not-checked-in");

  /* ─────────── state / caches ─────────── */
  let employees   = [];                 // loaded once per session
  const cache     = new Map();          // date → rows[]
  let baseRows    = [];                 // rows currently feeding the search box
  let currentDate = "";

  /* ─────────── helpers ─────────── */
  const loaderRow =
    `<tr><td colspan="7" style="text-align:center;padding:30px;">
       <div class="loader"></div>
     </td></tr>`;

  const rowHTML = r => {
  // coordinates that may or may not exist
  const assigned = (r.Coordinates || "").split(/,\s*/);
  const aLat = Number(assigned[0]);
  const aLng = Number(assigned[1]);
  const cLat = r.geopoint?.latitude;
  const cLng = r.geopoint?.longitude;

  console.log(`[row] ${r.IDNo}`, { aLat, aLng, cLat, cLng });
  return `
    <tr
      data-idno="${r.IDNo}"
      ${Number.isFinite(aLat) ? `data-assigned-lat="${aLat}" data-assigned-lng="${aLng}"` : ""}
      ${Number.isFinite(cLat) ? `data-checkin-lat="${cLat}" data-checkin-lng="${cLng}"`   : ""}
    >
      <td>${r.IDNo}</td>
      <td>${r.Name}</td>
      <td>${r.checkInTime  ? new Date(r.checkInTime .seconds*1000).toLocaleTimeString() : "—"}</td>
      <td>${r.checkOutTime ? new Date(r.checkOutTime.seconds*1000).toLocaleTimeString() : "—"}</td>
      <td>${r.Contract  ?? "—"}</td>
      <td>${r.Location  ?? "—"}</td>
      <td>${
          r.geopoint
            ? `${cLat.toFixed(4)}°, ${cLng.toFixed(4)}°`
            : "—"
        }</td>
    </tr>`;
};


  function render(rows) {
    tableBody.innerHTML = rows.length
      ? rows.map(rowHTML).join("")
      : `<tr><td colspan="7" style="text-align:center;">No records</td></tr>`;
  }

  /* ─────────── Firestore pulls ─────────── */
  async function loadEmployeesOnce() {
    if (employees.length) return;
    const snap = await getDocs(collection(db, `companies/${COMPANY}/employees`));
    employees  = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function loadDay(dateStr) {
    if (cache.has(dateStr)) return cache.get(dateStr);

    const tasks = employees.map(emp => {
      const empId = (emp.IDNo ?? emp.id).toString();      // sub-collection name
      const ref   = doc(
        db,
        `companies/${COMPANY}/employees/${empId}/attendanceRecords/${dateStr}`
      );

      // try cache first, fall back to server
      return getDocFromCache(ref).catch(() => getDoc(ref))
                 .then(snap => snap.exists() ? { emp, data: snap.data() } : null);
    });

    const raw = await Promise.all(tasks);
    const rows = raw
      .filter(Boolean)
      .map(({ emp, data }) => ({
        IDNo        : emp.IDNo ?? emp.id,
        Name        : emp.Name ?? "—",
        Contract    : data.contract,
        Location    : data.locationName,
        Coordinates : (emp.Coordinates ?? "").trim(),   // ← NEW
        checkInTime : data.checkInTimestamp,
        checkOutTime: data.checkOutTimestamp,
        geopoint    : data.checkInLocation
      }));

    cache.set(dateStr, rows);
    return rows;
  }

  /* ─────────── KPI counters (fast path for today) ─────────── */
  async function fillCountersQuickIfToday() {
    const today = new Date().toISOString().slice(0, 10);
    if (currentDate !== today) return false;
    try {
      const snap = await getDocFromCache(doc(db, SUMMARY))
                    .catch(() => getDoc(doc(db, SUMMARY)));
      if (snap.exists()) {
        const d = snap.data();
        empVal.textContent  = d.totalEmployees ?? "—";
        chkVal.textContent  = d.presentToday   ?? "—";
        nChkVal.textContent = (d.totalEmployees ?? 0) - (d.presentToday ?? 0);
        return true;
      }
    } catch {}
    return false;
  }

  /* ─────────── top-level refresh chain ─────────── */
  async function fullRefresh() {
    currentDate = dateInput.value || new Date().toISOString().slice(0, 10);
    tableBody.innerHTML = loaderRow;

    await loadEmployeesOnce();
    const rows = await loadDay(currentDate);

    if (!(await fillCountersQuickIfToday())) {
      empVal.textContent  = employees.length;
      chkVal.textContent  = rows.length;
      nChkVal.textContent = employees.length - rows.length;
    }

    baseRows = rows;           // master list for current KPI filter
    render(baseRows);
    if (searchBox) searchBox.value = "";
  }

  /* ─────────── KPI card filters ─────────── */
  function showAll() {
    baseRows = cache.get(currentDate) || [];
    render(baseRows);
  }

  function showIn() {
    const all = cache.get(currentDate) || [];
    baseRows  = all.filter(r => r.checkInTime);
    render(baseRows);
  }

  function showOut() {
    const all        = cache.get(currentDate) || [];
    const checkedIds = new Set(all.filter(r => r.checkInTime).map(r => r.IDNo));
    baseRows = employees
      .filter(e => !checkedIds.has(e.IDNo ?? e.id))
      .map(e => ({ IDNo: e.IDNo ?? e.id, Name: e.Name ?? "—" }));
    render(baseRows);
  }

  /* ─────────── live search ─────────── */
  if (searchBox) {
    searchBox.addEventListener("input", () => {
      const q = searchBox.value.trim().toLowerCase();
      if (!q) return render(baseRows);           // cleared → reset
      render(
        baseRows.filter(r =>
          (r.IDNo + "").includes(q) ||
          (r.Name      ?? "").toLowerCase().includes(q) ||
          (r.Location  ?? "").toLowerCase().includes(q)
        )
      );
    });
  }

  /* ─────────── listeners ─────────── */
  dateInput .addEventListener("input", fullRefresh);
  cardAll   .addEventListener("click", () => { showAll(); cardAll.focus();  });
  cardIn    .addEventListener("click", () => { showIn();  cardIn .focus();  });
  cardOut   .addEventListener("click", () => { showOut(); cardOut.focus();  });
  document.getElementById("nav-attendance")
           .addEventListener("click", fullRefresh);

  /* ─────────── bootstrap ─────────── */
  await fullRefresh();

  
  // helper ──────────────────────────────────────────
// "25.13548, 55.25514" OR "25.13548° N, 55.25514° E" → {lat, lng}
function toLatLng(str) {
  if (!str) return null;
  const nums = str.match(/[-\d.]+/g);
  return nums && nums.length >= 2 ? { lat: +nums[0], lng: +nums[1] } : null;
}

/* main handler ───────────────────────────────────*/
tableBody.addEventListener('click', e => {
  const row = e.target.closest('tr[data-idno]');
  if (!row) return;                    // ignore clicks outside rows

  const idNo = row.dataset.idno;

  /* 1️⃣  primary source ─ data-attributes added when rendering */
  let aLat = parseFloat(row.dataset.assignedLat);
  let aLng = parseFloat(row.dataset.assignedLng);
  let cLat = parseFloat(row.dataset.checkinLat);
  let cLng = parseFloat(row.dataset.checkinLng);

  /* 2️⃣  fallback ─ master list (assigned) and cell text (check-in) */
  if (!Number.isFinite(aLat) || !Number.isFinite(aLng)) {
    const emp    = employees.find(e => (e.IDNo ?? e.id) == idNo);
    const parsed = toLatLng(emp?.Coordinates);
    if (parsed) ({ lat: aLat, lng: aLng } = parsed);
  }

  if (!Number.isFinite(cLat) || !Number.isFinite(cLng)) {
    const parsed = toLatLng(row.children[6]?.textContent || '');
    if (parsed) ({ lat: cLat, lng: cLng } = parsed);
  }

  console.log('[click]', idNo, { aLat, aLng, cLat, cLng });

  /* 3️⃣  guards */
  if (!(Number.isFinite(aLat) && Number.isFinite(aLng))) {
    return alert('Assigned coordinates missing for this employee.');
  }
  if (!(Number.isFinite(cLat) && Number.isFinite(cLng))) {
    return alert('Check-in coordinates missing for this employee.');
  }

  /* 4️⃣  open Google Maps */
  const url = `https://www.google.com/maps/dir/${aLat},${aLng}/${cLat},${cLng}`;
  console.log('[url]', url);
  window.open(url, '_blank');
});


</script>



</body>
</html>